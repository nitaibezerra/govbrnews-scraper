name: Main News Processing Pipeline

on:
  schedule:
    # Runs every day at 4AM UTC (midnight BrasÃ­lia)
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYY-MM-DD)'
        required: false
        type: string
      end_date:
        description: 'End date (YYYY-MM-DD)'
        required: false
        type: string

jobs:
  setup-dates:
    name: Setup Date Variables
    runs-on: ubuntu-latest
    outputs:
      start_date: ${{ steps.dates.outputs.start_date }}
      end_date: ${{ steps.dates.outputs.end_date }}
    steps:
      - name: Set date variables
        id: dates
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.start_date }}" ]; then
            echo "start_date=${{ inputs.start_date }}" >> $GITHUB_OUTPUT
            echo "end_date=${{ inputs.end_date || inputs.start_date }}" >> $GITHUB_OUTPUT
          else
            echo "start_date=$(date -d '1 day ago' +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            echo "end_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          fi

      - name: Print date information
        run: |
          echo "Pipeline will process from ${{ steps.dates.outputs.start_date }} to ${{ steps.dates.outputs.end_date }}"

  run-pipeline:
    name: Run News Processing Pipeline
    needs: setup-dates
    uses: ./.github/workflows/pipeline-steps.yaml
    with:
      start_date: ${{ needs.setup-dates.outputs.start_date }}
      end_date: ${{ needs.setup-dates.outputs.end_date }}
    secrets:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      COGFY_API_KEY: ${{ secrets.COGFY_API_KEY }}